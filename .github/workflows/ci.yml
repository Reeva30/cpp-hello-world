name: Build OpenTwin

on:
  push:
    branches:
      - RunBuild

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        repository: OT-OpenTwin/OpenTwin
        path: 'OpenTwin'
        ref: 'Ci'
        
    - name: Set up the environment
      run: |
        echo "OPENTWIN_DEV_ROOT=D:\a\OpenTwin" >> $GITHUB_ENV
        echo "DEVENV_ROOT_2022=C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE" >> $GITHUB_ENV

    - name: Install Chocolatey
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force; 
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'));

    - name: Install Visual Studio Build Tools
      run: choco install -y visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Workload.NativeDesktop --add Microsoft.VisualStudio.Component.Windows10SDK --add Microsoft.VisualStudio.Component.VC.Redist.14.Latest"

    - name: Install Rust
      run: rustup default stable

    - name: Set environment variables
      run: echo "OPENTWIN_DEV_ROOT=D:\a\OpenTwin" >> $GITHUB_ENV

    - name: Validate environment variable
      run: echo %OPENTWIN_DEV_ROOT%

    - name: Run build script
      run: |
        set "OPENTWIN_DEV_ROOT=D:\a\OpenTwin"
        cd %OPENTWIN_DEV_ROOT%\Repo\Deployment
        dir

    - name: Build All
      run: |
        set "OPENTWIN_DEV_ROOT=D:\a\OpenTwin"
        cd %OPENTWIN_DEV_ROOT%\Repo\MasterBuild
        .\buildAll.bat

    - name: Create Deployment
      run: |
        set "OPENTWIN_DEV_ROOT=D:\a\OpenTwin"
        cd %OPENTWIN_DEV_ROOT%\Repo\MasterBuild
        .\createDeployment.bat
