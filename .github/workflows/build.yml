name: Install Qt VS Add-in and Build Qt Project

on:
  push:
    branches:
      - try
  pull_request:
    branches:
      - try

env:
  DEVENV_PATH: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE
  QT_PATH: D:\a\cpp-hello-world\cpp-hello-world\ThirdParty\Qt\6.6.1\msvc2019_64
  QtMsBuild: D:\a\cpp-hello-world\cpp-hello-world\ThirdParty\QtMsBuild
  QtToolsPath: D:\a\cpp-hello-world\cpp-hello-world\ThirdParty\Qt\6.6.1\msvc2019_64\bin

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Check out the main project repository
        uses: actions/checkout@v4
        with:
          repository: OT-OpenTwin/OpenTwin
          ref: Ci
          path: OpenTwin

     
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtcharts qtwebengine'
          archives: 'qtbase qtsvg'
          cache: 'false'
          setup-python: 'true'
          tools: 'tools_ifw tools_qtcreator,qt.tools.qtcreator'
          set-env: 'true'
          tools-only: 'false'
          aqtversion: '==3.1.*'
          py7zrversion: '==0.20.*'
          extra: '--external 7z'

      - name: Install Qt Visual Studio Tools Extension
        shell: powershell
        run: |
          $vsixPath = "$env:TEMP\QtVsTools.vsix"
          Invoke-WebRequest -Uri "https://download.qt.io/development_releases/vsaddin/3.0.2/qt-vsaddin-msvc2022-3.0.2.vsix" -OutFile $vsixPath
          Start-Process -FilePath "$env:DEVENV_PATH\devenv.exe" -ArgumentList "/InstallVSPackage $vsixPath" -Wait

      - name: Verify Qt Visual Studio Tools Installation
        shell: powershell
        run: |
          $extensions = & "$env:DEVENV_PATH\devenv.exe" /GetInstalledExtensions
          $qtExtension = $extensions | Select-String -Pattern "Qt Visual Studio Tools"
          if ($qtExtension) {
            Write-Host "Qt Visual Studio Tools installed successfully."
          } else {
            Write-Host "Qt Visual Studio Tools installation failed."
            exit 1
          }

      - name: Set Environment Variables for Qt and MSBuild
        shell: powershell
        run: |
          $env:PATH="$env:QtToolsPath;$env:QtMsBuild;$env:PATH"
          Write-Output "QT_PATH=$env:QT_PATH" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Output "QtMsBuild=$env:QtMsBuild" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Output "QtToolsPath=$env:QtToolsPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Output "PATH=$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Environment variables set."
